KISAS
=====
_Insert general description of the project here_

Clone project
-------------
```
git clone https://github.com/phvheumen/kisas.git
cd kisas
git submodule update --init --recursive
```

Software reference documentation
--------------------------------
The documentation for the classes, its members and methods is generated by Doxygen.
Doxygen is a documentation generator, a tool for writing software reference documentation. The documentation is written within code, and is thus relatively easy to keep up to date. Doxygen can cross reference documentation and code, so that the reader of a document can easily refer to the actual code.

#### How to generate documentation
In the source tree a configuration file `Doxyfile` is provided. This file is condigured for this project and shouldn't need to change. However, feel free to change configuration to personal preferences. In order to generate documentation make sure the following tools are installed and added to the `PATH` environment variable. Both tools are available for Windows and Linux.

* Doxygen (http://www.doxygen.org)
* Graphviz (http://www.graphviz.org)

Once installed go to the root directory of the project and excecute the following command:
```shell
doxygen Doxyfile
```
Now a directory `doc` should be created (if not existing yet), and the reference documentation is located in there.
If one continues to work on this project, it is advised to update and create documentation in the style found elsewhere in the project. In this way the reference documenation is always complete and up to date.

Install toolchain (Windows)
---------------------------
The KISAS project is build on top of the Particle, a Internet-of-Things platform. See https://www.particle.io/ for more information. For this reason the software heavily depends on the Particle firmware. Normally one can create and build a Particle application in the online IDE. However we choose to develop and compile the application offline for the following reasons:
1. **Debugging** Usage of a GDB debugger is possible when code is offline compiled with debug information. This makes debugging problems within the code much more easier than only have a serial port available for debugging code. 
2. **Code navigation** When project complexity increases and the number of lines of code grows. Navigating trough the code becomes more challanging. Offline we have the availability of tools like Eclips to easily navigate through code and discover problems already before compiling.
3. **Firmware changes** Possibly there are application specification that require some modification of the Particle firmware itself.

#### Set up build environment (CYGWIN)
_Note: This installation guide is based on the description on https://docs.particle.io/support/particle-tools-faq/local-build/_

1. Download the latest version of cygwin form https://cygwin.com/. Also see this website for more details on installation if you are not familiar with cygwin. Following steps assume basic understanding of cygwin and its installation process.
2. Install cygwin on a convenient location (e.g. `C:/cygwin/`).
3. Install the following packages:
	* `Make`
	* `Git`
4. Download the GNU ARM Embedded Toolchain (5.4-2016q3). _Insert link here_
5. Install GNU ARM Embedded Toolchain on a convenient location. At the end of the installation uncheck `Launch gccvar.bat` and `Add registry information` to prevent interferance with other toolchains already installed on your system.
6. Download [buildtools_win.zip](https://docs.particle.io/assets/files/buildtools_win.zip). Then copy the crc32.exe and xxd.exe application to a suitable location where the executables are found. It is recommend to copy it in the `/usr/local/bin` directory of your cygwin installation. _Note: If for whatever reason this download is not available anymore, you should compile `crc32` and `xxd` from source. These applications are part of fairly common linux packages (so source should be easily found). Build the source against the cygwin DLL. See https://cygwin.com/ for more information about compiling application for usage with cygwin._


_If you are planning to only build within Eclipse, you can skip the following steps. However it is recommend to set this up anyway, because it will come in handy to debug the build process in the terminal when Eclipse fails to build the project properly_

5. In the installation root directory of cygwin edit the file `/home/<user>/.bash_profile`. If the GNU ARM Toolchain is installed, for example, in `C:\GNU Tools ARM Embedded\5.4 2016q3` add the following line to `.bash_profile`: `PATH="/cygdrive/c/GNU Tools ARM Embedded/5.4 2016q3/bin:${PATH}"`. _Note the backward slashes are converterted to forward slashes._
6. Start cygwin and check if the command `which arm-none-eabi-gcc` points to the directory where the ARM Toolchain is installed. You can check version of the toolchain by using the command `arm-none-eabi-gcc --version`

### Set up Eclipse
_Follow the instructions on: https://docs.particle.io/support/particle-tools-faq/eclipse-debug/_

From the above instructions, skip the step where you copy their Makefile to the project. The Makefile provided by this project suffies and help you to build from Cygwin and from Eclipse.

### Build
Building from cygwin is working properly at the moment. Use `make clean` the first time to build everythin including the complete Particle firmware. When making modification to the firmware `make clean` needs to be invoked again. The complete build can take some time to complete (10 to 15 minutes).
For normal work on the KISAS specific part, it suffies to use `make all` or simply `make`.

### Debugging
_See instructions on: https://docs.particle.io/support/particle-tools-faq/eclipse-debug/_

By default the there is a breakpoint at the entry of main() and at the entry of setup(). So you are required to press the continue button twice to actually start running the firmware.

As the software at the moment is, the LED starts with an white fading pattern. Connect the micro USB to the computer and open a terminal for the virtual COM port created by the particle. Press any key in the terminal and the software starts to run, giving some status info about booting/connections and the debug messages currently present in the software.

Sometimes windows fails to create this virtual COM port. Try to reset the particle then. 

Example of what currently the output is in the terminal:
```
KISAS: Keep it simple asset sensor
Particle system version: 0.7.0-rc.7
Free memory: 97136 Bytes
Device ID: 1b004d000b51343334363138

[  12.008] Start connecting to cellular network
[  14.509] Cellular: module on
[  14.869] Cellular: connecting to cellular network
[  14.869] Cellular: connected
[  14.869] Cellular: IP adress available [10.45.27.55]
[  14.869] Connecting to Particle cloud
[  15.573] Connected to Particle cloud.
[  15.573] Initialising ADE7880
[  15.641] Starting HTTP requests service
[  15.641] Starting application manager
[  15.641] Application> systemID: "Particle"
[  15.642] Application> applicationID: "PeriodicCall"
[  15.642] Application> messageFormatID: "0"
[  15.642] Boot complete

Free memory: 93072 Bytes

[  15.653] HttpClient::stateIdle> Entry
[  20.642] PeriodicCall::run> Entry
```
